---
title: "Avaliação dos Avanços de Rondonópolis (MT) em Relação ao Objetivo de Desenvolvimento Sustentável 6 (ODS 6) – Água Potável e Saneamento"
author: "Camily Nunes dos Santos"
date: "`r format(Sys.Date(), '%d de %B de %Y')`"
output: 
  html_document:
    css: "estilo.css"
    code_folding: hide
  pdf_document: default
params:
  exemplo_param: "Exemplo"
---

::: {style="display: flex; justify-content: space-between; width: 50%; padding: 10px;"}
<!-- Primeira imagem (no canto superior esquerdo) -->

<img src="Image/logtipo_projeto2/logtipo_projeto_oficial.png" style="width: 45%; height: auto;"/> <!-- Segunda imagem (no canto superior direito) --> <img src="https://ufr.edu.br/protic/wp-content/uploads/2022/04/PROEXA-branco.png" style="width: 45%; height: auto;"/>
:::

## 1. Introdução

O Objetivo de Desenvolvimento Sustentável 6 (ODS 6), definido pela Organização das Nações Unidas, busca assegurar a disponibilidade e a gestão sustentável da água potável e do saneamento para todos até 2030. Diante dessa meta global, este artigo se propõe a avaliar o progresso do município de Rondonópolis, no Mato Grosso, em relação às metas específicas do ODS 6. Além do objetivo de avaliação, a motivação para o estudo reflete a curiosidade de compreender o nível de alinhamento do município com essas metas, mesmo considerando a limitação de dados disponíveis. Essa visão local é essencial, pois pode tanto orientar prefeituras e unidades prestadoras de serviços (água e esgoto) em suas políticas como servir de exemplo para a adequação de outros municípios.

A análise prioriza as metas 6.1 e 6.2 do ODS 6, pois ambas tratam diretamente as áreas centrais para o estudo das condições de saneamento básico. A Meta 6.1 visa alcançar o acesso universal e equitativo à água potável e segura até 2030, com foco no fornecimento de água de qualidade para toda a população. A Meta 6.2, por sua vez, abrange o acesso a saneamento e higiene adequados, o que inclui tanto o fornecimento de serviços de esgoto quanto a disponibilidade de instalações para lavagem das mãos com água e sabão.

Essas duas metas são fundamentais para avaliar a situação de Rondonópolis no que se refere ao saneamento básico e às necessidades de infraestrutura. As outras metas do ODS 6 (6.3, 6.4, 6.5, 6.6, 6.a e 6.b) também abordam questões relacionadas à água, mas incluem aspectos mais amplos, como a gestão de recursos hídricos, qualidade ambiental e a preservação de ecossistemas hídricos. A análise destas outras metas poderá ser objeto de estudos futuros, permitindo um panorama ainda mais completo do setor de saneamento e água no município.

## 2. Objetivo

O estudo visa verificar se o município de Rondonópolis está caminhando na direção das metas do ODS 6, com foco em:

6.1: Acesso universal e equitativo à água potável segura;\
6.2: Acesso a saneamento e higiene adequados e equitativos, eliminando a defecação a céu aberto;\
6.3: Melhoria da qualidade da água e aumento da reciclagem e reutilização;  
6.4: Eficiência no uso da água e redução da escassez de água; \
6.5: Implementação da gestão integrada dos recursos hídricos; \
6.6: Proteção e restauração de ecossistemas aquáticos; \
6.7: Ampliação da cooperação internacional para apoio técnico e capacitação;    
6.8: Fortalecimento da participação comunitária na gestão da água e saneamento.\

## 3. Metodologia

O processo metodológico envolve a instalação e carregamento de pacotes, além do processamento e tratamento dos dados disponibilizados pelo Sistema Nacional de Informações sobre Saneamento (SNIS). No entanto, em 2023, o SNIS encerrou suas atividades relacionadas à coleta de informações sobre a prestação de serviços de todos os componentes do saneamento básico. A partir de 2024, o Sistema Nacional de Informações em Saneamento Básico (SINISA) assumiu as atividades, dando continuidade ao legado do SNIS e aprimorando a gestão das informações do setor.

### 3.1 **Pacotes Utilizados**

A análise faz uso de pacotes da linguagem R que permitem manipulação, visualização e análise de dados espaciais e tabulares. Os pacotes principais incluem:

-   tidyverse: Um conjunto de pacotes (como dplyr e ggplot2) para manipulação e visualização de dados.

-   plotly: Para criação de visualizações interativas.

-   sf: Manipulação e visualização de dados espaciais.

-   readr: Para leitura eficiente de dados tabulares.

-   httr: Validação de conexões HTTP ao acessar repositórios online de dados.

### 3.2 Descrição Geral da Análise

A análise está estruturada em três etapas principais:

#### a) **Coleta de Dados**

Os dados foram obtidos do Sistema Nacional de Informações sobre Saneamento (SNIS) e carregados diretamente de repositórios online. Para garantir a confiabilidade das fontes, a URL foi verificada usando o pacote `httr`.

#### b) **Tratamento e Limpeza de Dados**

Os dados foram tratados para atender aos objetivos específicos da análise:

-   Seleção de variáveis relevantes, como população atendida, índices de coleta e tratamento de esgoto, e volume de resíduos sólidos coletados.

-   Conversão de formatos e preenchimento de valores ausentes para garantir a consistência.

-   Foco no município de **Rondonópolis**, com filtragem de dados baseada no nome do município.

#### c) **Análise Descritiva e Alinhamento às Metas do ODS 6**

A análise descritiva será realizada para medir indicadores específicos relacionados ao ODS 6, como:

-   **Meta 6.1**: Proporção da população com acesso a água potável.

-   **Meta 6.2**: Proporção da população com serviços de saneamento seguro.

### 3.3 **Ferramentas de Visualização**

Para tornar os resultados mais acessíveis e compreensíveis, serão utilizadas:

-   **Gráficos Estáticos**: Criados com `ggplot2` para representar indicadores principais.

-   **Gráficos Interativos**: Utilizando `plotly` para permitir a exploração detalhada dos dados.

-   **Mapas Temáticos**: Criados com `sf` para ilustrar a distribuição espacial de serviços e infraestrutura.

### 3.4 **Validação e Interpretação dos Resultados**

Os resultados serão avaliados para:

-   Identificar discrepâncias ou áreas críticas em Rondonópolis.

-   Comparar os indicadores locais às metas globais do ODS 6.

-   Propor estratégias para melhoria nos serviços de saneamento básico.

### 3.5 Instalar e Carregar Pacotes

Para realizar a análise, utilizamos uma série de pacotes no R, essenciais para manipulação, visualização e análise de dados geoespaciais e de séries temporais.

-   **Instalar Pacotes (se necessário):**

Primeiramente, verificamos se os pacotes necessários estão instalados. Caso não estejam, são instalados automaticamente.

```{r, warning=FALSE,echo=FALSE,message=FALSE}
# Lista de pacotes necessários
pacotes <- c("ggplot2", "dplyr", "tidyr", "plotly", "readr", "zoo", "censobr", "geobr", "sf", "httr", "jsonlite")  
  
# Instalar os pacotes que ainda não estão instalados
pacotes_nao_instalados <- pacotes[!(pacotes %in% installed.packages()[,"Package"])]
if(length(pacotes_nao_instalados)) install.packages(pacotes_nao_instalados)
```

-   **Carregamento dos Pacotes**:

Após garantir que todos os pacotes estão instalados, eles são carregados no ambiente R.

```{r, warning=FALSE,echo=FALSE,message=FALSE, results='hide'}
lapply(pacotes, function(pkg) {
  if (!requireNamespace(pkg, quietly = TRUE)) {
    install.packages(pkg)
  }
  suppressMessages(library(pkg, character.only = TRUE))
})
```

Esses pacotes garantem uma base sólida para o carregamento, manipulação e visualização dos dados que serão utilizados na análise.

### 3.6 Carregar os Dados

Os dados utilizados neste estudo foram extraídos do Sistema Nacional de Informações sobre Saneamento (SNIS) e estão hospedados em um repositório do GitHub. Para assegurar a reprodutibilidade, o código carrega diretamente o arquivo CSV a partir da URL fornecida.

-   **Fonte dos Dados**: Repositório GitHub da pesquisadora (Colocar o link aqui).
-   **Formato do Arquivo**: Arquivo CSV com separador `;` e codificação `ISO-8859-1`, que permite a leitura correta de caracteres em português.

```{r, warning=FALSE,echo=FALSE,message=FALSE}
url <- "https://github.com/CamilyNunes/Produto_San_Bas_Roo/raw/refs/heads/main/Dados/SNIS%20-%20S%C3%A9rie%20Hist%C3%B3rica/Agregado-20240925161723-SNISMT.csv"  

if (!httr::http_error(url)) {
  san_mt <- read_delim(url, delim = ";", locale = locale(encoding = "ISO-8859-1"))
} else {
  stop("Erro ao acessar a URL fornecida. Verifique o link.")
}
```

### 3.7 Tratamento dos Dados

Após o carregamento, realizamos o tratamento dos dados para selecionar as variáveis de interesse e garantir que os indicadores relevantes para o estudo estejam bem organizados. Esse processo inclui a seleção das variáveis de saneamento e o filtro para a cidade de Rondonópolis.

-   **Desabilitar Notação Científica:** Para garantir que os números não sejam representados em notação científica.

```{r, warning=FALSE,echo=FALSE,message=FALSE}
options(scipen = 999) 
```

-   **Seleção de variaveis de Interesse**: Glossário de informações

O SNIS atualmente está dividido em três componentes: água e esgotos (SNIS-AE), resíduos sólidos (SNIS-RS) e Águas Pluviais (SNIS-AP), mas as variáveis que precisamos está no componete água e esgotos (SNIS-AE). A seguir segue as informações das variáveis utilizadas.

```{r, warning=FALSE,echo=FALSE,message=FALSE}
# selecionar variaveis de referencia
san <- san_mt[,c(1:10)]
```

Geral

1.  Água:

AG001 - POPULAÇÃO TOTAL ATENDIDA COM ABASTECIMENTO DE ÁGUA

Valor da população total atendida com abastecimento de água pelo prestador de serviços, no último dia do ano de referência. Corresponde à população urbana que é efetivamente atendida com os serviços acrescida de outras populações atendidas localizadas em áreas não consideradas urbanas. Essas populações podem ser rurais ou mesmo com características urbanas, apesar de estarem localizadas em áreas consideradas rurais pelo IBGE. Caso o prestador de serviços não disponha de procedimentos próprios para definir, de maneira precisa, essa população, o mesmo poderá estimá-la utilizando o produto da quantidade de economias residenciais ativas de água (AG013), multiplicada pela taxa média de habitantes por domicílio do respectivo município, obtida no último Censo ou Contagem de População do IBGE. Quando isso ocorrer, o prestador de serviços deverá abater da quantidade de economias residenciais ativas de água, o quantitativo correspondente aos domicílios atendidos e que não contam com população residente. Como, por exemplo, em domicílios utilizados para veraneio, em domicílios utilizados somente em finais de semanas, imóveis desocupados, dentre outros. Assim, o quantitativo de economias residenciais ativas a ser considerado na estimativa populacional normalmente será inferior ao valor informado em AG013. A população AG001 deve ser menor ou igual à população da informação G12a.
Referências: AG025; AG026; X030; X040; X050; X095; X115; X125; X185. Unidade: Habitantes.

AG026 - POPULAÇÃO URBANA ATENDIDA COM ABASTECIMENTO DE ÁGUA

Valor da população urbana atendida com abastecimento de água pelo prestador de serviços, no último dia do ano de referência. Corresponde à população urbana que é efetivamente atendida com os serviços. Caso o prestador de serviços não disponha de procedimentos próprios para definir, de maneira precisa, essa população, o mesmo poderá estimá-la utilizando o produto da quantidade de economias residenciais ativas de água (AG013), na zona urbana, multiplicada pela taxa média de habitantes por domicílio do respectivo município, obtida no último Censo ou Contagem de População do IBGE. Quando isso ocorrer, o prestador de serviços deverá abater da quantidade de economias residenciais ativas de água, existentes na zona urbana, o quantitativo correspondente aos domicílios atendidos e que não contam com população residente. Como, por exemplo, domicílios utilizados para veraneio, domicílios utilizados somente em finais de semana, imóveis desocupados, dentre outros. Assim o quantitativo de economias residenciais ativas a ser considerado na estimativa populacional normalmente será inferior ao valor informado em AG013, considerando a área urbana. AG026 não deve ser confundida com a população urbana residente nos municípios com abastecimento de água, identificada pelo código G06a. A população AG026 deve ser menor ou igual à população da informação G06a.
Referências: AG001; AG013; AG025; X035; X040; X050; X115; X185. Unidade: Habitantes.

AG007 - VOLUME DE ÁGUA TRATADA EM ETAS

Volume anual de água submetido a tratamento, incluindo a água bruta captada pelo prestador de serviços e a água bruta importada (AG016), medido ou estimado na(s) saída(s) da(s) ETA(s)\*. Deve estar computado no volume de água produzido (AG006). Não inclui o volume de água tratada por simples desinfecção em UTS(s) (AG015) e nem o volume importado de água já tratada (AG018).
Referências: AG006; AG015; AG016; AG018; X065; X115; X160. Unidade: 1.000 m³/ano.   
*Estação de tratamento de água (ETA) é o local onde a água captada de uma fonte superficial ou subterrânea é tratada e purificada para se tornar potável, ou seja, própria para o consumo humano, ou para se tornar adequada para uso industrial.

AG015 - VOLUME DE ÁGUA TRATADA POR SIMPLES DESINFECÇÃO  

Volume anual de água captada de manancial subterrâneo ou fonte de cabeceira, ou de água bruta importada, que apresenta naturalmente características físicas, químicas e organolépticas que a qualificam como água potável e, por isto, é submetida apenas a simples desinfecção, medido ou estimado na(s) saída(s) da(s) UTS(s). Deve estar computado no volume de água produzido (AG006). Não inclui o volume de água tratada em ETA(s) (AG007) e nem o volume de água tratada importada (AG018).
Referências: AG006; AG007; AG016; AG018; X065; X160. Unidade: 1.000 m³/ano.

```{r, warning=FALSE,echo=FALSE,message=FALSE}
#Meta 6.1(a)
#Geral
san$Pop_total_atendida_abas_agua <- san_mt$`AG001 - População total atendida com abastecimento de água`
san$Pop_urbana_atendida_abas_agua <- san_mt$`AG026 - População urbana atendida com abastecimento de água`
san$Pop_rural_atendida_abas_agua <- san_mt$`AG025A - População rural atendida com abastecimento de água no ano anterior ao de referência.`  
san$Volume_agua_tratada_ETAs <- san_mt$`AG007 - Volume de água tratada em ETAs`
san$Volume_agua_tratada_simples_desinfecção <- san_mt$`AG015 - Volume de água tratada por simples desinfecção`
```

2.  Esgoto e Coleta de lixo:

```{r, warning=FALSE,echo=FALSE,message=FALSE}
#6.2(a)
san$Pop_total_atendida_esgotamento_sanitario <- san_mt$`ES001 - População total atendida com esgotamento sanitário`
san$Pop_urbana_atendida_esgotamento_sanitario <- san_mt$`ES026 - População urbana atendida com esgotamento sanitário`
san$Qtd_ligacoes_ativas <-san_mt$`ES002 - Quantidade de ligações ativas de esgotos` 

#6.2(b)
san$Pop_urbana_residente_esgotamento_sanitario <- san_mt$`G06B - População urbana residente do(s) município(s) com esgotamento sanitário`
san$Indice_tratamento_esgoto_percentual <- san_mt$`IN016 - Índice de tratamento de esgoto`

#outros
san$Indice_coleta_esgoto <- san_mt$`IN015 - Índice de coleta de esgoto`
san$Volume_esgoto_coletado_m3 <- san_mt$`ES005 - Volume de esgotos coletado`
san$Volume_esgoto_tratado <- san_mt$`ES006 - Volume de esgotos tratado`
```

Diferença entre as variaveis com a descrição de 'atendida' e 'com (abastecimento)':

Atendida (acesso a água potável segura): Implica não apenas a presença de um sistema de abastecimento, mas também a garantia de que a água é potável, segura e gerida adequadamente.

Com abastecimento de água: Refere-se ao simples fornecimento de água, sem garantir que ela seja tratada ou que atenda aos padrões de segurança e qualidade para consumo humano.

-   **Filtragem por Município:**

A seguir, filtramos os dados para o município de Rondonópolis, que é o foco deste estudo.

```{r}
# Filtrando a cidade de Rondonópolis
san_roo <- san[san$Município == "Rondonópolis", ]  
```

-   **Padronização das Colunas**:

Para facilitar a interpretação, renomeamos algumas colunas, garantindo a consistência no conjunto de dados.

```{r, warning=FALSE,echo=FALSE,message=FALSE}
# Supondo que a coluna em uma das tabelas esteja com um nome diferente, renomeie para padronizar
san_roo <- san_roo %>%
  rename(`Ano` = `Ano de Referência`) %>%
  mutate(Ano = as.numeric(Ano))
```

Esse tratamento garante que os dados estejam prontos para análise, permitindo explorar os indicadores de forma estruturada e analisar o progresso do município em relação às metas do ODS 6.

## 4. Análise dos Dados

Nesta seção, exploramos os dados de saneamento básico e consumo de água para o município de Rondonópolis, com o objetivo de avaliar seu progresso em relação às metas do ODS 6. A análise inclui a visualização da qualidade e completude dos dados, o cálculo de indicadores fundamentais e a criação de gráficos interativos que facilitam a interpretação e exploração dos dados ao longo do tempo.

### 4.1 Visualização dos Resultados Tratados

Antes de prosseguir com análises, é fundamental verificar a consistência dos dados.

### 4.1 Análise de Valores Ausentes

Para garantir a consistência e a confiabilidade da análise, é essencial identificar e visualizar a proporção de valores ausentes em cada variável do conjunto de dados. Isso permite compreender melhor as lacunas de dados que podem impactar os resultados.

-   **Gráfico de Proporção de Valores Ausentes**:

A seguir, apresentamos um gráfico de barras empilhadas que mostra a proporção de valores presentes e ausentes para cada variável. Esse gráfico ajuda a identificar quais variáveis necessitam de atenção adicional. Vale destacar que as informações do SNIS são coletadas anualmente de prestadores de serviços ou órgãos municipais responsáveis pela gestão dos serviços. A base de dados é totalmente pública e disponibilizada gratuitamente no site www.gov.br/cidades/pt-br/acesso-a-informacao/acoes-e-programas/saneamento/snis. No entanto, pode ocorrer que os prestadores de serviços não possuam ou não tenham informado os dados relativos a determinadas variáveis ou anos, o que pode resultar em valores ausentes.

```{r, warning=FALSE,echo=FALSE,message=FALSE}
# 1. Criar uma função que calcula a proporção de valores omissos (NA) por coluna
calc_missing_proportion <- function(df) {
  missing_data <- sapply(df, function(col) {
    mean(is.na(col))
    })
  
  missing_df <- data.frame(
    Peso = names(missing_data),
    Omissos = missing_data)
  
  missing_df <- missing_df %>%
    filter(Omissos > 0)
  
  return(missing_df)
}

# 2. Calcular a proporção de valores omissos no conjunto de dados
missing_proportions <- calc_missing_proportion(san_roo)

# 3. Preparar os dados para a plotagem em forma de gráfico de barra empilhada
plot_data <- missing_proportions %>%
  mutate(Presentes = 1 - Omissos) %>%
  pivot_longer(cols = c(Omissos, Presentes), 
               names_to = "Valores", 
               values_to = "Proporcao")

# 4. Definir as cores de acordo com seu Tema dos Gráficos
cor_omisso <- "#FF6347"
cor_presente <- "#006400"

# 5. Criar o gráfico de coluna empilhada em 100% e inverter os eixos
gg <- ggplot(plot_data, aes(x = Proporcao, 
                             y = Peso, 
                             fill = Valores )) +
  geom_bar(stat = "identity", position = "fill") +
  scale_x_continuous(labels = scales::percent) +
  labs(
    title = "Proporção de Valores Omissos por Variável",
    x = "Proporção (%)",
    y = " ") +
  scale_fill_manual(values = c("Omissos" = cor_omisso, "Presentes" = cor_presente), 
                    labels = c("Valores Presentes", "Valores Omissos")) + 
  theme_minimal() + 
  theme(
    axis.title.x = element_text(size = 12, face = "bold", color = "black"),
    axis.title.y = element_text(size = 11, face = "bold", color = "black", angle = 90),
    plot.title = element_text(size = 11, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 12, hjust = 0.5),
    panel.grid.major = element_line(color = "grey85"),
    panel.grid.minor = element_blank())  

# Salvar o gráfico em um arquivo PNG
ggsave(
  filename = 'grafico_proporcao_omissos.png', 
  plot = gg, 
  path = 'resultados',
  width = 8,
  height = 4,
  units = 'in')
  
# 6. Converter o gráfico ggplot em um gráfico interativo com plotly
interactive_plot <- ggplotly(gg)

# 7. Mostrar o gráfico interativo
interactive_plot
```

```{r, fig.width=12, fig.height=14, warning=FALSE,echo=FALSE,message=FALSE}
# 1. Calcular a proporção de valores omissos por variável e ano
calc_missing_by_year <- function(df) {
  # Selecionar apenas colunas numéricas e a coluna "Ano"
  numeric_cols <- df %>%
    select(where(is.numeric), Ano)
  
  # Transformar para formato longo
  df_long <- numeric_cols %>%
    pivot_longer(-Ano, names_to = "Variavel", values_to = "Valor") %>%
    group_by(Ano, Variavel) %>%
    summarise(
      Omissos = mean(is.na(Valor)),
      Presentes = 1 - mean(is.na(Valor)),
      .groups = "drop")
  return(df_long)
}

# 2. Preparar os dados para a plotagem
missing_by_year <- calc_missing_by_year(san_roo)

plot_data <- missing_by_year %>%
  pivot_longer(cols = c(Omissos, Presentes),
               names_to = "Valores",
               values_to = "Proporcao")

# 3. Definir as cores
cor_omisso <- "#FF6347"
cor_presente <- "#006400"

# 4. Criar o gráfico com ggplot
gg <- ggplot(plot_data, aes(x = Ano, 
                            y = Proporcao, 
                            fill = Valores)) +
  geom_bar(stat = "identity", position = "fill") +
  facet_wrap(~Variavel, scales = "free_y", ncol = 2) +  # Organizar em duas colunas
  scale_y_continuous(labels = scales::percent) +
  scale_fill_manual(
    values = c("Omissos" = cor_omisso, "Presentes" = cor_presente),
    labels = c("Valores Omissos", "Valores Presentes")
  ) +
  labs(
    title = "Valores Omissos e Presentes por Variável e Ano",
    x = "Ano",
    y = "Proporção (%)") +
  theme_minimal() +
  theme(
    axis.title.x = element_text(size = 12, face = "bold"),
    axis.title.y = element_text(size = 11, face = "bold"),
    plot.title = element_text(size = 11, face = "bold", hjust = 0.5),
    legend.position = "bottom")

# 5. Salvar o gráfico com tamanho ajustado para melhor visibilidade
ggsave(
  filename = "grafico_omissos_por_variavel_ano.png",
  plot = gg,
  path = "resultados",
  width = 12,  # largura
  height = 14, # altura
  units = "in")

# 6. Converter para interativo com plotly
interactive_plot <- ggplotly(gg)

# 7. Mostrar o gráfico interativo
interactive_plot

```

O gráfico acima permite identificar rapidamente as variáveis com valores ausentes. As variáveis com maiores proporções de omissão indicam potenciais lacunas nos dados do SNIS, que devem ser consideradas nas interpretações dos resultados.

```{r, warning=FALSE,echo=FALSE,message=FALSE}
# 1. Armazenamento do Dataset Completo
# A variável 'data' recebe o dataset 'san' completo.
# Isso permite o uso de todos os dados na análise subsequente.
data <- san_roo

# 3. Definição da Legenda para Gráficos
# Define a legenda para as visualizações que utilizam a variável 'datavar'.
# A legenda indica que a variável representa o "Consumo Percapita de Água" em litros por habitante por dia.
legendavar <- ' '

# Definição de chave para a média
#A variável chave é atribuída ao valor 'media', indicando que será utilizada para calcular a média em análises futuras.
chave <- 'media'
```

4.  Funções de Suporte para Gráficos

```{r, warning=FALSE,echo=FALSE,message=FALSE}
# Função para limpar strings, removendo espaços, caracteres especiais e acentos
cleanStr <- function(string) {
  
  # Carregar pacotes necessários apenas uma vez
  if (!require(stringi)) install.packages("stringi", quietly = TRUE)
  if (!require(stringr)) install.packages("stringr", quietly = TRUE)
  
  # Limpar e normalizar a string
  string <- str_replace_all(string, ' ', '_')
  string <- str_replace_all(string, '-', '_')
  string <- str_replace_all(string, '%', '')
  string <- str_replace_all(string, '/', '_')
  string <- stri_trans_general(string, "latin-ascii")
  string <- tolower(string)
  
  return(string)
}
```

5.  Definir Tema Personalizado para Gráficos (ggplot2)

```{r, warning=FALSE,echo=FALSE,message=FALSE}
tema_plot <- function(dataTime, legendavar, chave) {
  
  # Criar gráfico básico de linha com o tema minimalista
  plot <- ggplot(data = dataTime, aes(x = tempo, y = x, group = 1)) +
            geom_line(color = "#3586ff", size = 1.2) +  # Linha na cor verde-escura
            geom_label(aes(label = label), size = 3, color = "#3586ff", nudge_y = 0.5) +  # Rótulos em verde-escuro
            labs(
              title = "Evolução Temporal de Rondonópolis (MT)",
              subtitle = legendavar,
              x = "Ano",  # Legenda para o eixo X
              y = legendavar  # Legenda para o eixo Y
            ) +
            scale_x_continuous(
              breaks = seq(from = min(dataTime$tempo), to = max(dataTime$tempo), by = 1),
              limits = c(min(dataTime$tempo), max(dataTime$tempo)),
              expand = c(0, 0)  # Remover margens extras
            ) +
            scale_color_distiller(palette = "Greens", direction = 1) +  # Paleta de cores Greens
            theme_minimal() %+replace%  # Manter um tema minimalista com os eixos
            theme(
              axis.title.x = element_text(size = 10, face = "bold", color = "black"),  # Legenda do eixo X
              axis.title.y = element_text(size = 10, face = "bold", color = "black", angle = 90),  # Legenda Y na vertical
              axis.text.x = element_text(size = 10, angle = 45, hjust = 1),  # Texto do eixo X com rotação
              axis.text.y = element_text(size = 10),  # Texto do eixo Y
              plot.title = element_text(size = 14, face = "bold", hjust = 0.5),  # Título centralizado
              plot.subtitle = element_text(size = 12, hjust = 0.5),  # Subtítulo centralizado
              panel.grid.major.x = element_blank(),  # Remover linhas de grid principais do eixo X
              panel.grid.major.y = element_line(color = "grey85"),  # Linhas de grid principais do eixo Y
              panel.grid.minor = element_blank(),  # Remover grid secundário
              legend.position = "none"  # Sem legenda adicional
            )
  
  # Agregar escala Y caso solicitado
  if (chave == 'agregar') {
    plot <- plot + scale_y_continuous(limits = range(dataTime$x, na.rm = TRUE))
  }
  
  # Salvar o gráfico em um arquivo PNG
  ggsave(
    filename = paste0('grafico_', cleanStr(legendavar), '.png'), 
    plot = plot, 
    path = 'resultados',
    width = 8,
    height = 4,
    units = 'in')
  
  # Converta o gráfico ggplot em um gráfico interativo
  plot_interativo <- ggplotly(plot)
  
  return(plot_interativo)
}
```

```{r, warning=FALSE,echo=FALSE,message=FALSE}
dev01 <- function(data, datavar, chave, legendavar) {
  
  if (chave == 'agregar') {
    # agregar valores
    dataTime = aggregate(datavar, by = list(tempo = as.numeric(data$`Ano`)), FUN = sum)
  } else if (chave == 'media') {
    # tirar media valores
    dataTime = aggregate(datavar, by = list(tempo = as.numeric(data$`Ano`)), FUN = mean)
    dataTime$x = round(dataTime$x, 2)
  } else {
    stop("Chave não encontrada! Tente 'agregar' ou 'media'.")
  }
  
  # label
  dataTime$label <- NA
  n <- min(5, nrow(dataTime)) #Seleciona no máximo 5 pontos
  idx <- seq(1, nrow(dataTime), length.out = n)
  dataTime$label[idx] <- dataTime$x[idx]
  
  # A coluna 'x' precisa ser definida aqui
  colnames(dataTime)[2] <- "x"  # Renomeia a coluna para 'x'
  
  # gráfico
  plot = tema_plot(dataTime, legendavar, chave)
  return(plot)
}
```

# Verificação dos Indicadores do ODS 6

A análise do desempenho de Rondonópolis em relação à Meta 6 do ODS 6 é limitada pela ausência de dados completos. Contudo, para obter uma visão geral, utilizamos dados do Sistema Nacional de Informações sobre Saneamento (SNIS) e da Tabela 6579 da SIDRA do IBGE, que fornece estimativas da população residente.

## Água Potável e Saneamento

Garantir disponibilidade e manejo sustentável da água e saneamento para todos.

### Meta 6.1: Acesso Universal e Equitativo à Água Potável e Segura

Até 2030, alcançar o acesso universal e equitativo a água potável e segura para todos.

Para município de Rondonópolis é possível analisar a série histórica de abastecimento de água entre 1999 a 2022, conforme ilustrado no gráfico a seguir. Os dados mostram um aumento de habitantes atendidos ao longo dos anos e durante um período de 10 anos a população obeteve acesso a abastecimento de água crescente de 190.750 habitantes em 2010 para 244.911 habitantes em 2022, indicando uma evolução positiva no alcance dos serviços de água.

```{r, warning=FALSE,echo=FALSE,message=FALSE}
dev01(san_roo, san_roo$Pop_total_atendida_abas_agua, 'media','Pop. total com Abastecimento de Água (Habitantes)')
```

### Meta 6.1.1: Proporção da População com Água Potável

Esta seção realiza a análise da proporção da população tanto rural quanto urbanha de Rondonópolis com acesso a água potável gerida de forma segura. O indicador 6.1.1 mede a porcentagem da população atendida por serviços de água potável, considerando as seguintes condições de segurança:

-   Fonte aprimorada de água: inclui redes gerais de distribuição, poços artesianos e poços rasos protegidos.

-   Localização da água: deve estar disponível no domicílio ou na propriedade do residente. 

-   Disponibilidade e segurança: a água deve estar disponível conforme a necessidade e livre de contaminação fecal ou química.

#### 1. Filtragem e Preparação dos Dados

O primeiro passo é filtrar os dados para o intervalo de anos de interesse (2001 a 2021), pois assim é possível usar os dados fornecidos pela SIDRA e selecionar as colunas relevantes, como o ano e a quantidade de população atendida por serviços de água potável. A coluna de população atendida pode conter caracteres especiais, como vírgulas ou pontos, que são removidos para garantir que a variável seja numérica. Este é o código utilizado:

```{r, warning=FALSE,echo=FALSE,message=FALSE}
# Filtrar os dados para o intervalo de anos e selecionar as colunas desejadas
san_meta <- san_roo %>%
  dplyr::filter(`Ano` >= 2001 & `Ano` <= 2021) %>%
  dplyr::select(
    `Ano`, 
    `Pop_total_atendida_abas_agua`, 
    `Pop_urbana_atendida_abas_agua`, 
    `Pop_rural_atendida_abas_agua`) %>%
  dplyr::mutate(
    Pop_total_atendida_abas_agua = as.numeric(gsub("[.,]", "", Pop_total_atendida_abas_agua)),
    Pop_urbana_atendida_abas_agua = as.numeric(gsub("[.,]", "", Pop_urbana_atendida_abas_agua)),
    Pop_rural_atendida_abas_agua = as.numeric(gsub("[.,]", "", Pop_rural_atendida_abas_agua))) 
```

### 2. Coleta de Dados de População

Para calcular a proporção, é necessário utilizar os dados da população total de Rondonópolis, que podem ser extraídos da API SIDRA do IBGE. Para isso, usamos a tabela 6579 do Sistema IBGE de Recuperação Automática (SIDRA), que apresenta estimativas anuais da população residente. O acesso à tabela pode ser feito através do link: [https://www.ibge.gov.br/busca.html?searchword=6579].

```{r, warning=FALSE,echo=FALSE,message=FALSE}
# URL da API do SIDRA para população de Rondonópolis
url <- "https://apisidra.ibge.gov.br/values/t/6579/p/all/n6/5107602"

# Requisitar dados da API
resposta <- GET(url)
populacao_roo <- fromJSON(content(resposta, "text"))
```

### 3. Preparação dos Dados de População

A resposta da API do SIDRA contém várias colunas, mas estamos interessados apenas nas colunas de ano e população total. As colunas são extraídas e convertidas para o formato numérico:

```{r, warning=FALSE,echo=FALSE,message=FALSE}
# Selecionar colunas relevantes, incluindo o código do município
pop_total <- populacao_roo %>%
  select(Ano = D1N, Populacao = V) %>%
  mutate(Ano = as.numeric(Ano), 
         Populacao = as.numeric(Populacao))
```

### 4. Unindo os Dados e Calculando a Proporção

Com os dados de população de Rondonópolis e os dados de atendimento por água potável já preparados, unimos as duas fontes de informação com base no ano. Em seguida, calculamos a proporção da população atendida por serviços de água potável, dividindo o número de pessoas atendidas pela população total de cada ano e multiplicando por 100 para obter o percentual:

```{r, warning=FALSE,echo=FALSE,message=FALSE}
san_bas <- inner_join(san_meta, pop_total, "Ano")
```

```{r, warning=FALSE,echo=FALSE,message=FALSE}
# Criar novas colunas com a divisão das variáveis de população atendida por abastecimento de água pela população total
meta61 <- san_bas %>%
  mutate(
    Pop_total_atendida_pct = (Pop_total_atendida_abas_agua / Populacao) * 100,
    Pop_urbana_atendida_pct = (Pop_urbana_atendida_abas_agua / Populacao) * 100,
    Pop_rural_atendida_pct = (Pop_rural_atendida_abas_agua / Populacao) * 100)
```

```{r, warning=FALSE,echo=FALSE,message=FALSE}
# gráfico de barras
grafico_barras <- meta61 %>%
  ggplot(aes(x = Ano)) +
  
  # População total atendida
  geom_bar(aes(y =  Pop_total_atendida_pct, fill = "Total", text = paste0(round(Pop_total_atendida_pct, 2), "%")), 
           stat = "identity", position = "dodge", width = 0.8) +
  
  # População urbana atendida
  geom_bar(aes(y =  Pop_urbana_atendida_pct, fill = "Urbana", text = paste0(round(Pop_urbana_atendida_pct, 2), "%")), 
           stat = "identity", position = "dodge", width = 0.8) +
  
  # População rural atendida
  geom_bar(aes(y = Pop_rural_atendida_pct, fill = "Rural", text = paste0(round(Pop_rural_atendida_pct, 2), "%")), 
           stat = "identity", position = "dodge", width = 0.8) +
  scale_fill_manual(values = c("Total" = "#FF9999", "Urbana" = "#66B3FF", "Rural" = "#99FF99")) + # Definindo cores diferentes
  
  labs(
    title = "População Atendida por Abastecimento de Água",
    x = "Ano",
    y = "Porcentagem (%)",
    fill = "Tipo de População"
  ) +
  theme_minimal() +
  theme(
    legend.position = "top",
    plot.title = element_text(size = 16, face = "bold"),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10),
    plot.margin = margin(1, 1, 1, 1, "cm")
  )

# Tornar o gráfico interativo
grafico_interativo <- ggplotly(grafico_barras, tooltip = "text")

# Exibir o gráfico interativo
grafico_interativo

# Salvar o gráfico como JPG na pasta "resultados"
ggsave(
  filename = "resultados/grafico_pop_atendida.jpg", 
  plot = grafico_barras, 
  width = 10, 
  height = 6, 
  units = "in", 
  dpi = 300)
```

Inicialemnte, é possivel verificar que em 2021 de 100% da população total 96,19% da população urbana foi atendida com abastecimento de água. A 

# Meta 6.2 - Acesso a Saneamento e Higiene Adequados até 2030

A Meta 6.2 da ODS 6 visa alcançar, até 2030, o acesso universal e equitativo a saneamento e higiene adequados para todos, com especial atenção para as necessidades de mulheres, meninas e indivíduos em situação de vulnerabilidade. Esta meta também busca erradicar a prática da defecação a céu aberto. Os indicadores para essa meta incluem:

6.2(a): Proporção da população que utiliza serviços de saneamento geridos de forma segura. 6.2(b): Proporção da população com acesso a instalações de lavagem de mãos com água e sabão.

## Indicador 6.2(a): Proporção da População com Saneamento Seguro

Para calcular a proporção da população que utiliza serviços de saneamento geridos de forma segura, considera-se a população atendida com esgoto tratado como indicador de saneamento seguro.

No caso do Sistema Nacional de Informações sobre Saneamento (SNIS), as variáveis relevantes para esse cálculo incluem:

ES001: População total atendida com esgotamento sanitário: : Esta variável informa a quantidade de população que é atendida com serviços de esgoto, seja com coleta ou tratamento de esgoto.

ES026 - População urbana atendida com esgotamento sanitário: Se você deseja analisar especificamente a população urbana, esta variável é mais indicada.

ES002 - Quantidade de ligações ativas de esgotos: Embora não forneça diretamente a população atendida, ela pode ser útil para entender a infraestrutura de saneamento, que é um fator importante para o atendimento com esgoto.

A fórmula para calcular a proporção de população com acesso a esgoto tratado é:

No código abaixo, são realizadas as operações para calcular essa proporção:

```{r, warning=FALSE,echo=FALSE,message=FALSE}
# Filtrar os dados para o intervalo de anos e selecionar as colunas desejadas
san_meta62a <- san_roo %>%
  dplyr::filter(`Ano` >= 2001 & `Ano` <= 2021) %>%
  dplyr::select(
    `Ano`, 
    `Pop_total_atendida_esgotamento_sanitario`, 
    `Pop_urbana_atendida_esgotamento_sanitario`, 
    `Qtd_ligacoes_ativas`) %>%
  dplyr::mutate(
    Pop_total_atendida_esgotamento_sanitario = as.numeric(gsub("[.,]", "", Pop_total_atendida_esgotamento_sanitario)),
    Pop_urbana_atendida_esgotamento_sanitario = as.numeric(gsub("[.,]", "", Pop_urbana_atendida_esgotamento_sanitario)),
    Qtd_ligacoes_ativas = as.numeric(gsub("[.,]", "", Qtd_ligacoes_ativas)))
```

```{r, warning=FALSE,echo=FALSE,message=FALSE}
san_meta62a <- inner_join(san_meta62a, pop_total, "Ano")
```

```{r, warning=FALSE,echo=FALSE,message=FALSE}
# Criar novas colunas com a divisão das variáveis de população atendida por abastecimento de água pela população total
san_meta621a <- san_meta62a %>%
  mutate(
    Pop_total_atendida_esgotamento_sanitario_pct = (Pop_total_atendida_esgotamento_sanitario / Populacao) * 100,
    Pop_urbana_atendida_esgotamento_sanitario_pct = (Pop_urbana_atendida_esgotamento_sanitario / Populacao) * 100)
```

```{r, warning=FALSE,echo=FALSE,message=FALSE}
grafico_barras <- san_meta621a %>%
  ggplot(aes(x = Ano)) +
  # Barra para a população total atendida por esgoto sanitário
  geom_bar(aes(y = Pop_total_atendida_esgotamento_sanitario_pct, fill = "Total", 
               text = paste0(round(Pop_total_atendida_esgotamento_sanitario_pct, 2), "%")), 
           stat = "identity", position = "dodge") +
  # Barra para a população urbana atendida por esgoto sanitário
  geom_bar(aes(y = Pop_urbana_atendida_esgotamento_sanitario_pct, fill = "Urbana", 
               text = paste0(round(Pop_urbana_atendida_esgotamento_sanitario_pct, 2), "%")), 
           stat = "identity", position = "dodge") +
  labs(
    title = "População Atendida por Esgoto Sanitário",
    x = "Ano",
    y = "Porcentagem (%)",
    fill = "Tipo de População") +
  theme_minimal() +
  theme(
    legend.position = "top",
    plot.title = element_text(size = 16, face = "bold"),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10))

# Tornar o gráfico interativo
grafico_interativo <- ggplotly(grafico_barras, tooltip = "text")

# Exibir o gráfico interativo
grafico_interativo

# Salvar o gráfico como JPG na pasta "resultados"
ggsave(
  filename = "resultados/grafico_pop_atendida_esgoto.jpg", 
  plot = grafico_barras, 
  width = 10, 
  height = 6, 
  units = "in", 
  dpi = 300)

```

## 6.2(b)

Indicador 6.2(b): Proporção da População com Acesso a Instalações de Lavagem de Mãos

Embora o SNIS não forneça uma variável direta sobre o acesso a instalações de lavagem de mãos com água e sabão, é possível inferir esse acesso a partir dos dados sobre cobertura de água e esgoto. O acesso a esgoto tratado pode ser um indicativo indireto de que as instalações de lavagem de mãos também estão disponíveis, já que, em geral, municípios com infraestrutura de saneamento também possuem sistemas de água e higiene adequados.

A variável mais diretamente relacionada para a meta 6.2(b) seria:

G06B: População urbana residente do município com esgotamento sanitário.

Embora a análise direta de instalações de lavagem de mãos exija dados complementares ou mais específicos, o acesso ao esgoto tratado pode servir como um indicador aproximado.

Descrição das Variáveis:

O volume de esgoto coletado (ES005) refere-se à quantidade de esgoto recolhida no sistema de saneamento, enquanto o volume de esgoto tratado (ES006) é o que passa por algum processo de tratamento antes de ser lançado no meio ambiente.

Unidades de Medida: Especifique as unidades, geralmente metros cúbicos (m³) ou litros.

Cálculo da Razão de Tratamento: Calcule a proporção do volume tratado em relação ao coletado

(ES006/ES005)×100% para cada período e/ou região, o que evidencia a eficiência do sistema de tratamento.

```{r, warning=FALSE,echo=FALSE,message=FALSE}
dev01(san_roo, san_roo$Volume_esgoto_coletado_m3, 'media','Volume Esgoto Coletado (m³)')
dev01(san_roo, san_roo$Volume_esgoto_tratado, 'media', 'Volume Esgoto Tratado (m³)')

dev01(san_roo, san_roo$Indice_coleta_esgoto, 'agregar','Índice de Coleta de Esgoto')
dev01(san_roo, san_roo$Indice_tratamento_esgoto_percentual, 'agregar','Índice Tratamento de Esgoto')
```
